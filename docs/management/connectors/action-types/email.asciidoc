[[email-action-type]]
== Email connector and action
++++
<titleabbrev>Email</titleabbrev>
++++

The email connector uses the SMTP protocol to send mail messages, using an 
integration of https://nodemailer.com/[Nodemailer]. An exception is Microsoft 
Exchange, which uses HTTP protocol for sending emails, 
https://docs.microsoft.com/en-us/graph/api/user-sendmail[Send mail]. Email 
message text is sent as both plain text and html text.

[NOTE]
====
* For emails to have a footer with a link back to {kib}, set the 
<<server-publicBaseUrl, `server.publicBaseUrl`>> configuration setting.
* When the 
<<action-config-email-domain-allowlist,`xpack.actions.email.domain_allowlist`>> 
configuration setting is used, the email addresses used for all of the Sender 
(from), To, CC, and BCC properties must have email domains specified in the 
configuration setting.
====

[float]
[[email-connector-configuration]]
=== Connector configuration

Email connectors have the following configuration properties.

Name::
The name of the connector. The name is used to identify a  connector in the 
management UI connector listing, or in the connector list when configuring an 
action.

Sender::
The from address for all emails sent with this connector. This must be specified 
in `user@host-name` format. See the 
https://nodemailer.com/message/addresses/[Nodemailer address documentation] for 
more information.

Service::
The name of the email service. If `service` is one of Nodemailer's 
https://nodemailer.com/smtp/well-known/[well-known email service providers], the 
`host`, `port`, and `secure` properties are defined with the default values and 
disabled for modification. If `service` is `MS Exchange Server`, the `host`, 
`port`, and `secure` properties are ignored and `tenantId`, `clientId`, 
`clientSecret` are required instead. If `service` is `other`, the `host` and 
`port` properties must be defined.

Host::
Host name of the service provider. If you are using the 
<<action-settings, `xpack.actions.allowedHosts`>> setting, make sure this 
hostname is added to the allowed hosts.

Port::
The port to connect to on the service provider.

Secure::
If true, the connection will use TLS when connecting to the service provider. 
Refer to the 
https://nodemailer.com/smtp/#tls-options[Nodemailer TLS documentation] for more 
information. If not true, the connection will initially connect over TCP, then 
attempt to switch to TLS via the SMTP STARTTLS command.

Tenant ID::
The directory tenant that the application plans to operate against, in GUID 
format.

Client ID::
The application ID that is assigned to your app, in GUID format. You can find 
this information in the portal where you registered your app.

Client Secret::
The client secret that you generated for your app in the app registration 
portal. The client secret must be URL-encoded before being sent. The Basic auth 
pattern of providing credentials in the Authorization header, per 
https://datatracker.ietf.org/doc/html/rfc6749#section-2.3.1[RFC 6749], is also 
supported.

Require authentication::
If true, a username and password for login type authentication must be provided.

Username::
Username for login type authentication.

Password::
Password for login type authentication.

[float]
[[email-connector-networking-configuration]]
=== Connector networking configuration

Use the <<action-settings, Action configuration settings>> to customize 
connector networking configurations, such as proxies, certificates, or TLS 
settings. You can set configurations that apply to all your connectors or use 
`xpack.actions.customHostSettings` to set per-host configurations.

[float]
[[define-email-ui]]
==== Define connectors in {kib}

You can create connectors in *{stack-manage-app} > {connectors-ui}*
or as needed when you're creating a rule. For example:

[role="screenshot"]
image::management/connectors/images/email-connector.png[Email connector]

[float]
[[preconfigured-email-configuration]]
=== Create preconfigured connectors

If you are running {kib} on-prem, you can define connectors by adding
`xpack.actions.preconfigured` settings to your `kibana.yml` file. For example:

[source,text]
--
xpack.actions.preconfigured:
  my-email:
    name: preconfigured-email-connector-type
    actionTypeId: .email
    config:
      service: other
      from: testsender@test.com
      host: validhostname
      port: 8080
      secure: false
    secrets:
      user: testuser
      password: passwordkeystorevalue
--

Config defines information for the connector type.

`service`::
The name of the email service. If `service` is `elastic_cloud` (for Elastic 
Cloud notifications) or one of Nodemailer's 
https://nodemailer.com/smtp/well-known/[well-known email service providers], the 
`host`, `port`, and `secure` properties are ignored. If `service` is `other`,  
the `host` and `port` properties must be defined. For more information on the 
`gmail` service value, refer to 
https://nodemailer.com/usage/using-gmail/[Nodemailer Gmail documentation]. If 
`service` is `exchange_server`, the `tenantId`, `clientId`, `clientSecret` 
properties are required instead of `host` and `port`.

`from`::
An email address that corresponds to *Sender*.

`host`::
A string that corresponds to *Host*.

`port`::
A number that corresponds to *Port*.

`secure`::
A boolean that corresponds to *Secure*.

`hasAuth`::
A boolean that corresponds to *Requires authentication*. If `true`, this 
connector will require values for `user` and `password` inside the secrets 
configuration. Defaults to `true`.

`tenantId`::
A GUID format value that corresponds to *Tenant ID*, which is a part of OAuth 
2.0 Client Credentials Authentication.

`clientId`::
A GUID format value that corresponds to *Client ID*, which is a part of OAuth 
2.0 Client Credentials Authentication.

Secrets defines sensitive information for the connector type.

`user`::
A string that corresponds to *Username*. Required if `hasAuth` is set to `true`.

`password`::
A string that corresponds to *Password*. Should be stored in the 
<<creating-keystore, {kib} keystore>>. Required if `hasAuth` is set to `true`.

`clientSecret`::
A string that corresponds to *Client Secret*. Should be stored in the 
<<creating-keystore, {kib} keystore>>. Required if `service` is set to 
`exchange_server`, which uses OAuth 2.0 Client Credentials Authentication.

[float]
[[email-action-configuration]]
=== Test connectors

You can test connectors with the <<execute-connector-api,run connector API>> or
as you're creating or editing the connector in {kib}. For example:

[role="screenshot"]
image::management/connectors/images/email-params-test.png[Email params test]

Email actions have the following configuration properties:

To, CC, BCC::
Each item is a list of addresses. Addresses can be specified in `user@host-name` 
format, or in `name <user@host-name>` format. One of To, CC, or BCC must contain 
an entry.

Subject::
The subject line of the email.

Message::
The message text of the email. Markdown format is supported.

[float]
[[configuring-email]]
=== Configuring email accounts for well-known services

The email connector can send email using many popular SMTP email services and 
the Microsoft Exchange Graph API.

For more information about configuring the email connector to work with 
different email systems, refer to:

* <<elasticcloud>>
* <<email-connector-gmail>>
* <<email-connector-outlook>>
* <<email-connector-amazon-ses>>
* <<email-connector-microsoft-exchange>>

For other email servers, you can check the list of well-known services that 
Nodemailer supports in the JSON file 
https://github.com/nodemailer/nodemailer/blob/master/lib/well-known/services.json[well-known/services.json]. 
The properties of the objects in those files &mdash; `host`, `port`, and 
`secure` &mdash; correspond to the same email connector configuration 
properties. A missing `secure` property in the "well-known/services.json" file 
is considered `false`.  Typically, `port: 465` uses `secure: true`, and 
`port: 25` and `port: 587` use `secure: false`.

[float]
[[elasticcloud]]
==== Sending email from Elastic Cloud

IMPORTANT: To receive notifications, the email addresses must be added to an
    link:{cloud}/ec-watcher.html#ec-watcher-allowlist[allowlist] in the 
    Elasticsearch Service Console.
    
Use the preconfigured email connector (`Elastic-Cloud-SMTP`) to send emails from 
Elastic Cloud.

